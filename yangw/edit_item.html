<html lang="en">
	<head>
		<meta charset="utf-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0" />
		<link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons" />
		<link type="text/css" rel="stylesheet" href="fake_items.css" />
		<style type="text/css">
		</style>
		<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js" type="text/javascript"></script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/fastclick/1.0.6/fastclick.min.js" type="text/javascript"></script>
		<script src="https://acuth.github.io/awac/awac.js" type="text/javascript"></script>
		<script src="https://storage.googleapis.com/code.getmdl.io/1.0.0/material.min.js" type="text/javascript"></script>
		<script src="fake_items.js" type="text/javascript"></script>
		<script type="text/javascript">
			var _awac = null;
			var _fitem = null;

			function placeCaretAtEnd(el) {
			    if (typeof window.getSelection != "undefined"
			            && typeof document.createRange != "undefined") {
			        var range = document.createRange();
			        range.selectNodeContents(el);
			        range.collapse(false);
			        var sel = window.getSelection();
			        sel.removeAllRanges();
			        sel.addRange(range);
			    } else if (typeof document.body.createTextRange != "undefined") {
			        var textRange = document.body.createTextRange();
			        textRange.moveToElementText(el);
			        textRange.collapse(false);
			        textRange.select();
			    }
			}



			function onAction(action) {
			  if ('back' == action)
			    _awac.endPage();
			  else if ('edit:markdown' == action)
			    _awac.openPage('edit-markdown','edit_markdown.html',{'markdown':_fitem.json.markdown});
				else if ('edit:title' == action) {
					$('#item-title-div').find('.item-title').find('.right-control').remove();
					var t = $('#item-title-div').find('.item-title');//.find('.title-edit-div');
					t.attr('contenteditable',true).focus();
					placeCaretAtEnd(t.get(0));
				}
				else
			    _awac.alert('action '+action+' NYI');
			}

			function newSpan(classes) {
			  var d = $(document.createElement('span'));
			  if (classes) d.addClass(classes);
			  return d;
			}

			function newDiv(classes) {
			  var d = $(document.createElement('div'));
			  if (classes) d.addClass(classes);
			  return d;
			}

			function getActionSpan(name,action) {
			    var span = newSpan('edit-control-span');
          span.html('<i class="material-icons">'+action+'</i>');
          span.on('click',function(){onAction(action+':'+name);});
          return span;
			}

			function appendEditControls2(c,name,actions) {
			  if (actions)
          for (var i=0;i<actions.length;i++)
            getActionSpan(name,actions[i]).appendTo(c);
			}

			function getEditControl1(icon_name,action) {
				var div = newDiv('padded-container right-control');
				div.html('<i class="material-icons">'+icon_name+'</i>');
				div.on('click',function(){ console.log(action); onAction(action); });
				return div;
			}

			function getEditControl(iconName,action) {
				var div = document.createElement('div');
		    div.setAttribute('class','padded-container right-control');
		    var btn = document.createElement('button');
		    btn.setAttribute('class','mdl-button mdl-js-button mdl-button--icon');
		    btn.innerHTML = '<i class="material-icons mdl-color-text--blue-grey-400">'+iconName+'</i>';
		    btn.addEventListener('click',function() { onAction(action); });
		    div.appendChild(btn);
		    return $(div);
			}

			function fixEditLayout() {
			  var header = $('#edit-item-header');
			  var content = $('#edit-item-content');
			  var top = header.height()+'px';
			  var height = (_awac.getDims().height-header.height())+'px';
			  console.log('top '+top);
			  console.log('height '+height);
			  content.show().css('top',top).css('height',height);
			}


			function appendEditControls(c) {
			  var html = '<span class="edit-control-span"><i class="material-icons">delete</i></span>' +
			    '<span class="edit-control-span"><i class="material-icons">edit</i></span>';
			  c.html(html);
			}

			function appendClearBoth(c) {
			    var d = newDiv();
			    d.css('clear','both');
			    //d.html('-clear-both-');
			    d.appendTo(c);
			}



			function renderItem(fitem) {
			   console.log('edit_item.renderItem()');
			   console.log(JSON.stringify(fitem));
				  var iname = fitem.getMDIcon();
				  console.log('iname='+iname);
				  var a = fitem.getUserHTML(fitem.json.author,true);

			    var titleDiv = $('#item-title-div');
			    titleDiv.html('');
					//var h = '<div class="title-edit-div">'+fitem.json.name_attr+'</div>';
			    var t = newDiv('padded-container item-title').html(fitem.json.name_attr);
					getEditControl('edit','edit:title').appendTo(t);

					//var tdiv = t.get();
					//console.log('found '+tdiv);
					//componentHandler.upgradeElement(tdiv);

					t.appendTo(titleDiv);
					//componentHandler.upgradeDom();

			    var typesDiv = $('#item-types-div');
			    typesDiv.html('');
			    t = newDiv('left-content left');
			    newDiv('padded-container').css('display','flex').html('<div class="item-type"><i class="material-icons">'+iname+'</i></div>'+

			                '<div class="padded-container">'+fitem.json.item_type_name+'</div>').appendTo(t);
			    t.appendTo(typesDiv);
			    c = newDiv('right-controls edit-controls right');
			    p = newDiv('padded-container');
			    appendEditControls2(p,'type',['info']);
			    p.appendTo(c);
			    c.appendTo(typesDiv);
			    appendClearBoth(typesDiv);

			    var markdownDiv = $('#item-markdown-div');
			    markdownDiv.html('');
			    t = newDiv('left-content left');
			    newDiv('padded-container').html('<div class="item-markdown">'+fitem.json.markdown+'</div>').appendTo(t);
			    t.appendTo(markdownDiv);
			    c = newDiv('right-controls edit-controls right');
			    p = newDiv('padded-container');
			    appendEditControls2(p,'markdown',['edit']);
			    p.appendTo(c);
			    c.appendTo(markdownDiv);
			    appendClearBoth(markdownDiv);

			    //$('#edit-body-content').text(fitem.json.markdown).prop('readonly', true);
			    //$('#edit-body-content-control').click(function(event) { onAction('edit-markdown'); });
			    //_awac.startPage();
					var styleUrl = 'https://code.getmdl.io/1.1.1/material.blue-green.min.css';
					_awac.startMdlPage('toplevel',styleUrl);

			    _fitem = fitem;
			    setTimeout(fixEditLayout,60);
			}

			$(document).ready(function() {
			  _awac = new Awac('_awac');
			  var initp = _awac.getInitParam();
			  var fitem = new FItem(initp.json,true);
			  console.log('got fitem='+fitem);

			 var colors = _awac.getColors();
			 if (colors) {
			    $('#edit-item-header').css('background',colors.primary_dark);
			    $('#item-title').css('color',colors.text_primary);
			 }

			  _awac.setOnAction(onAction);
			  _awac.setOnBackPressed(function() { onAction('back'); });
			  _awac.setHomeItem({'label':'Back','icon':'close','action':'back'});

			  //_awac.addActionBarItem({'label':'DELETE','action':'delete'});
			  _awac.addActionBarItem({'label':'SAVE','action':'save'});

			  renderItem(fitem);
			});
			</script>
	</head>
	<body>
  	 <div id="toplevel" class="mdl-layout mdl-js-layout">

     <div id="item-title-div">-item-title-goes-here-</div>
     <div id="item-types-div">-item-types-go-here-</div>
     <div id="item-markdown-div">-item-markdown-goes-here-</div>

    <div style="position: relative;" id="edit-item-content">

       <table class="fields">

        <tr class="field">
           <td class="field-icon"><i class="material-icons">label</i></td>
           <td class="field-value">#android #funny</td>
           <td class="field-cntrl"><i class="material-icons">highlight_off</i></td>
        </tr>

        <tr class="field">
           <td class="field-icon"><i class="material-icons">check_box</i></td>
           <td class="field-value unset">Add to-do status</td>
        </tr>

        <tr class="field">
           <td class="field-icon"><i class="material-icons">location_on</i></td>
           <td class="field-value unset">Add location</td>
        </tr>

        <tr class="field">
           <td class="field-icon"><i class="material-icons">event</i></td>
           <td class="field-value unset">Add dates and times</td>
        </tr>

        <tr class="field">
           <td class="field-icon"><i class="material-icons">attach_file</i></td>
           <td class="field-value unset">Attach a file</td>
        </tr>

        <tr class="field">
           <td class="field-icon"><i class="material-icons">person</i></td>
           <td class="field-value unset">Connect to a person</td>
        </tr>




        </table>
     </div>

	 </div> <!-- toplevel -->
	</body>
</html>
