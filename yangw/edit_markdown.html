<html lang="en">
	<head>
		<meta charset="utf-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0" />
		<link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons" />
		<link type="text/css" rel="stylesheet" href="fake_items.css" />
		<style type="text/css">
		</style>
		<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js" type="text/javascript"></script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/fastclick/1.0.6/fastclick.min.js" type="text/javascript"></script>
		<script src="http://acuth.github.io/awac/awac.js" type="text/javascript"></script>
		<script src="https://storage.googleapis.com/code.getmdl.io/1.2.1/material.min.js" type="text/javascript"></script>
		<script src="fake_items.js" type="text/javascript"></script>
		<script type="text/javascript">
			var _awac = null;
			var _include_name = false;
			var _default_name = null;

			function startPage() {
				var styleUrl = 'https://code.getmdl.io/1.2.1/material.orange-indigo.min.css';
				_awac.startMdlPage('toplevel',styleUrl);
			}


			function placeCaretAtEnd(el) {
					if (typeof window.getSelection != "undefined"
									&& typeof document.createRange != "undefined") {
							var range = document.createRange();
							range.selectNodeContents(el);
							range.collapse(false);
							var sel = window.getSelection();
							sel.removeAllRanges();
							sel.addRange(range);
					} else if (typeof document.body.createTextRange != "undefined") {
							var textRange = document.body.createTextRange();
							textRange.moveToElementText(el);
							textRange.collapse(false);
							textRange.select();
					}
			}




			function onAction(action) {
			  if ('back' == action)
			    _awac.endPage();
			  else if ('save' == action) {
			     var md = $('#edit-item-markdown').val();
			     var name = null;
			     if (_include_name) {
			        name = $('#edit-item-name').val();
			        if (!name) {
			          _awac.alert('Need to supply a name');
			          return;
			        }
			     }
			     var item_id = null;
			     if (_include_item_id) {
						  _awac.alert('Need to supply an item-id');
			        return;
			     }
			     var outp = null;
			     if (_include_name || _include_item_id) {
			       outp = {};
			       outp.markdown = md;
			       if (_include_name) outp.name_attr = name;
			       if (_include_item_id) outp.item_id = item_id;
			     }
			     else {
			       outp = md;
			     }
			     _awac.endPage(outp);
			  }
			  else if ('edit:title' == action) {
					console.log('get rid of control');
					var t = $('#display-item-title').find('.item-title');
					t.find('.right-control').remove();

					//t.remove();//html('Fred');
					console.log('found t='+t);

					var ph = t.find('.title-placeholder');
					if (ph) {
						console.log('Found placeholder so remove it');
						ph.remove();
					}
					t.attr('contenteditable',true).focus();

					placeCaretAtEnd(t.get(0));
					componentHandler.upgradeDom();
					console.log('add done');
				}
				else
			    _awac.alert('action '+action+' NYI');
			}

			var _itemId = -1;
			var _markdown = null;


new function($) {
  $.fn.setCursorPosition = function(pos) {
    console.log('set cursor position '+pos);
    if (this.setSelectionRange) {
      this.setSelectionRange(pos, pos);
    } else if (this.createTextRange) {
      var range = this.createTextRange();
      range.collapse(true);
      if(pos < 0) {
        pos = $(this).val().length + pos;
      }
      range.moveEnd('character', pos);
      range.moveStart('character', pos);
      range.select();
    }
  }
}(jQuery);

			function fixEditLayout() {
			  var content = $('#edit-item-markdown');
			  var height = _awac.getDims().height;
			  if (_include_name) height -= 100; else height -= 20;
			  height += 'px';
			  console.log('height '+height);
			  content.show().css('height',height).focus().setCursorPosition(0);
			}

			function extractDefaultName(item_id) {
			  var result = '';
			  var addSpace = true;
			  for (var i=0;i<item_id.length;i++) {
			    var char = item_id.substring(i,i+1);
			    if (i != 0 && char >= 'A' && char <= 'Z') result += ' ';
			    result += char;
			  }
			  return result;
			}

			function getEditControl(iconName,action) {
				var div = document.createElement('div');
				div.setAttribute('class','padded-container right-control');
				var btn = document.createElement('button');
				btn.setAttribute('class','mdl-button mdl-js-button mdl-button--icon');
				btn.innerHTML = '<i class="material-icons mdl-color-text--blue-grey-400">'+iconName+'</i>';
				btn.addEventListener('click',function() { onAction(action); });
				div.appendChild(btn);
				return $(div);
			}

			$(document).ready(function() {
			  _awac = new Awac('_awac');
			  var initp = _awac.getInitParam();
			  _markdown = initp ? initp.markdown : '**This is Markdown**';
 			  console.log('_markdown='+_markdown);
 			  _include_name = initp.include_name;
 			  _include_item_id = initp.include_item_id;
 			  _default_name = initp.name;
 			  _default_item_id = initp.item_id;
 			  if (_default_item_id && !_default_name) _default_name = extractDefaultName(_default_item_id);

				var div = $('#display-item-title');
			  if (_include_name) {
					var name = _default_name;
					var icon = 'edit';
					if (!name) {
						name = '<span class="title-placeholder">add a title</span>';
						icon = 'add';
					}
					div.html('');
					var t = $(document.createElement('div'));
					t.addClass('padded-container item-title');
					t.html(name);
					getEditControl(icon,'edit:title').appendTo(t);
					t.appendTo(div);
				}
				else
					div.hide();

				div = $('#display-item-id');
			  if (_include_item_id && _default_item_id)
					div.html('<div class="wiki-name-div"><i>id:</i> <span class="wiki-name-span">'+_default_item_id+'</span></div>');
				else
					div.hide();

			  _awac.setOnAction(onAction);
			  _awac.setOnBackPressed(function() { onAction('back'); });
			  _awac.setHomeItem({'label':'Back','icon':'close','action':'back'});
			  _awac.addActionBarItem({'label':'SAVE','action':'save'});

				try {
				    //console.log(fitem.markdown);
  			  $('#edit-item-markdown').text(_markdown);
				} catch (err) {
				  console.log('got err='+err);
				}
				console.log('starting page');
	  		startPage();
	  		//setTimeout(fixEditLayout,60);
			});
			</script>
	</head>
	<body>
		<div id="toplevel" class="mdl-layout mdl-js-layout">
  	  <div id="display-item-title">item name goes here</div>
	    <div class="padded-container">
        <textarea id="edit-item-markdown" placeholder="Add a description/comment here..."></textarea>
				<div id="display-item-id">item-id goes here</div>
			</div>
	  </div> <!-- toplevel -->
	</body>
</html>
