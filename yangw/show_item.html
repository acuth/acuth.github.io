<html lang="en">
	<head>
		<meta charset="utf-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0" />
		<link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons" />
		<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Raleway:400,300,600" />
		<link type="text/css" rel="stylesheet" href="fake_items.css" />
		<style type="text/css">

		</style>
		<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js" type="text/javascript"></script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/fastclick/1.0.6/fastclick.min.js" type="text/javascript"></script>
		<script src="https://acuth.github.io/awac/awac.js" type="text/javascript"></script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/marked/0.3.5/marked.min.js" type="text/javascript"></script>
		<!--script src="https://cdnjs.cloudflare.com/ajax/libs/showdown/1.3.0/showdown.min.js" type="text/javascript"></script-->
		<script src="https://storage.googleapis.com/code.getmdl.io/1.2.1/material.min.js" type="text/javascript"></script>
		<script src="fake_items.js" type="text/javascript"></script>
		<script type="text/javascript">
			var _awac = null;
			var _itemId = null;
			var _fitem = null;

			function startPage() {
				var styleUrl = 'https://code.getmdl.io/1.2.1/material.orange-indigo.min.css';
				_awac.startMdlPage('toplevel',styleUrl);
				setTimeout(function(){console.log('update');componentHandler.upgradeDom();},10000);
			}

			function doTest() {
		   var html ='<span class="mdl-chip mdl-chip--deletable">'+
    //'<span class="mdl-chip__contact mdl-color--gray mdl-color-text--dark-orange"><i style="color:teal;font-size:18px;line-height:32px;" class="material-icons">label_outline</i></span>'+
    '<span class="mdl-chip__text">Contact Chip</span>'+
		'<a href="#" class="mdl-chip__action mdl-color-text--teal"><i class="material-icons">label_outline</i></a>'+
		'</span>';

		    html += '<hr/>Date <input type="date"/><br/>Time <input type="time"/>';

				document.getElementById('test-area').innerHTML = html;
				componentHandler.upgradeDom();
			}

			function onAction(action) {
				console.log('onAction('+action+')');
			  if ('signout' == action) {
			    _awac.signOut();
			    _awac.replacePage('signin','app_login.html',null,false);
			  }
			  else if ('back' == action)
			    showPrevPage();
				else if ('test' == action)
					doTest();
			  else if ('recent' == action)
			    showRecentItems();
			  else if ('comments' == action)
			    showCommentItems();
			  else if ('history' == action)
			    showHistory();
			  else if ('+comment' == action)
			    doAddComment();
			  else if ('+child' == action)
			    doAddChild();
			  else if (action.indexOf('new-tag:') == 0)
			    doNewTag(action.substring(8));
			  else if (action.indexOf('new-page:') == 0)
			    doNewPage(action.substring(9));
			  else if ('edit' == action) {
			    console.log('edit '+_itemId);
			    _awac.openPage('edit','edit_item.html',{'json':_fitem.json,'item_id':_itemId});
			  }
			  else if ('add' == action)
			    displayAddList();
			  else
			    _awac.alert('action '+action+' NYI');
			}

			function onPageClose(tag,ok,result) {
			  if (ok && result) {
  			  if (tag == 'edit-comment-markdown') {
	  		    FItem.addComment(_itemId,result,showNextPage);
			    }
			    else if (tag == 'edit-child-markdown') {
	  		    FItem.addChild(_itemId,result.name_attr,result.markdown,showNextPage);
			    }
			    else if (tag == 'new-tag-markdown') {
	  		    FItem.addTag(result.name_attr,result.markdown,showNextPage);
			    }
			    else if (tag == 'new-page-markdown') {
	  		    FItem.addPage(result.item_id,result.name_attr,result.markdown,showNextPage);
			    }
			    else if (tag == 'recent') {
			      console.log('show page '+result);
			      //showNextPage(item_id);
			    }
			    else {
			      console.log('page with tag '+tag+' has closed');
			    }
			  }
			}

			function displayAddList() {
			  // cannot add child posts to comments
			  // cannot add child items to users unless you are the user

			  var labels = ['new page','new tag','add comment','add child post','add next post'];
			  var actions = ['new-page:','new-tag:','+comment','+child','+next'];
			  var items = new Array();
			  for (var i=0;i<labels.length;i++) {
			      var item = new Object();
			      item.label = labels[i];
			      item.action = actions[i];
			      items[i] = item;
		    }
			  _awac.list(items,function(n) {
			    if (n != -1) {
			        var newAction = items[n].action;
			        if (newAction == '+comment' || newAction == '+child' || newAction.indexOf('new-page:') == 0 || newAction.indexOf('new-tag:') == 0)
			          onAction(newAction);
			        else
			          _awac.alert('selected '+newAction);
			    }
			  });
			}

			function doNewTag(tagName) {
			  _awac.openPage('new-tag-markdown','edit_markdown.html',{include_name:true,name:tagName,markdown:''});
			}

			function doNewPage(itemId) {
				var includeItemId = false;
				if (itemId) includeItemId = true;
			  _awac.openPage('new-page-markdown','edit_markdown.html',{include_name:true,include_item_id:includeItemId,item_id:itemId,markdown:''});
			}

			function doAddComment() {
			  _awac.openPage('edit-comment-markdown','edit_markdown.html',{'include_name':false,'markdown':''});
			}

			function doAddChild() {
			  _awac.openPage('edit-child-markdown','edit_markdown.html',{'include_name':true,'markdown':''});
			}

			function showRecentItems() {
			  var initp = {};
			  initp.items_hdr = 'Recent Items !!!!';
			  initp.op = 'recent';
			  _awac.replacePage('recent','recent_items.html',initp,true);
			}

			function showCommentItems() {
			  var initp = {};
			  initp.items_hdr = 'Comments';
			  initp.op = 'comments';
			  initp.item_id = _fitem.json.item_id;
			  _awac.replacePage('recent','recent_items.html',initp,true);
			}

			var _linkedItems = null;

			function selectLinked(i) {
			  var id = _linkedItems[i].item_id;
			  FItem.historyPush(_awac,id);
			  _awac.replacePage('show','show_item.html',{'item_id':id},true);
			}

			function onGetLinkedItems(json) {
			  var hdr = 'Linked Items';
			  if (_fitem.json.item_type_name == 'Page') hdr = 'Child Pages';
			  else if (_fitem.json.item_type_name == 'Tag') hdr = 'Tagged Items';
			  _linkedItems = json;
			  var html = '';
			  var found = false;
			  for (var i=0;i<json.length;i++) {
			    html += (new FItemRow(json[i])).getDiv(i,'selectLinked');
			    found = true;
			  }
			  if (found)
			    document.getElementById('linked-items').innerHTML = '<div class="padded-container"><h4>'+hdr+'</h4></div>'+html;
			}

			var _commentItems = null;

			function selectComment(i) {
			  var id = _commentItems[i].item_id;
			  FItem.historyPush(_awac,id);
			  _awac.replacePage('show','show_item.html',{'item_id':id},true);
			}

			function onGetCommentItems(json) {
			  var hdr = 'Comments';
			  _commentItems = json;
			  var html = '';
			  var found = false;
			  for (var i=0;i<json.length;i++) {
			    html += (new FItemRow(json[i])).getDiv(i,'selectComment');
			    found = true;
			  }
			  if (found)
			    document.getElementById('comment-items').innerHTML = '<div class="padded-container"><h4>'+hdr+'</h4></div>'+html;
			}


			function showHistory() {
			  _awac.replacePage('history','show_history.html',null,true);
			}

			function showNextPage(itemId) {
			  FItem.historyPush(_awac,itemId);
			  _awac.replacePage('show','show_item.html',{'item_id':itemId},true);
			}

			function showOptions(attr_name) {
			  _awac.alert('show options for attr '+attr_name);
			}

			function showUser(itemId) {
			  FItem.historyPush(_awac,itemId);
			  _awac.replacePage('show','show_item.html',{'item_id':itemId},true);
			}

			function appendEditControls(c) {
			  var html = '<span class="edit-control-span"><i class="material-icons">delete</i></span>' +
			    '<span class="edit-control-span"><i class="material-icons">edit</i></span>';
			  c.html(html);
			}

			function appendClearBoth(c) {
			    var d = newDiv();
			    d.css('clear','both');
			    //d.html('-clear-both-');
			    d.appendTo(c);
			}

			function newDiv(classes) {
			  var d = $(document.createElement('div'));
			  if (classes) d.addClass(classes);
			  return d;
			}

		  function renderItemHeader(fitem,iname,author) {
		      var titleDiv = $('#item-title-div');

					//<div class="padded-container item-title" style="position:relative;">
				 	//	A NEw Page With A Very Long Title
				 	// <div class="padded-container right-control">
				 	//	 <i class="material-icons">edit</i>
				 	// </div>
				  //</div>






			    titleDiv.html('');
			    newDiv('padded-container item-title').html(fitem.json.name_attr).appendTo(titleDiv);

			    var typesDiv = $('#item-types-div');
			    typesDiv.html('');
			    t = newDiv('left-content left');
			    newDiv('padded-container').css('display','flex').html('<div class="item-type"><i class="material-icons">'+iname+'</i></div>'+
			      '<div class="spacer"></div>' +
			      '<div>'+author+'</div>').appendTo(t);
			    t.appendTo(typesDiv);
			    //c = newDiv('right-controls edit-controls right');
			    //p = newDiv('padded-container');
			    //appendEditControls(p);
			    //p.appendTo(c);
			    //c.appendTo(typesDiv);
			    appendClearBoth(typesDiv);
		  }

			function showPrevPage() {
			   var itemId = FItem.historyPop(_awac);
			   if (itemId)
			     _awac.replacePage('show','show_item.html',{'item_id':itemId},false);
			   else
  			   _awac.replacePage('root','app_login.html',null,false);
			}


			$(document).ready(function() {
			  _awac = new Awac('_awac');
			  var initp = _awac.getInitParam();
			  if (initp)
			    _itemId = initp.item_id;
			  else
			    _itemId = 'HomePage';

			  console.log('item-id='+_itemId);

			  var colors = _awac.getColors();
			  if (colors) $('#item-title').css('color',colors.primary_dark);

			  _awac.setOnPageClose(onPageClose);
			  _awac.setOnAction(onAction);
			  _awac.addNavDrawerItem({'label':'Sign out','action':'signout'});
			  _awac.addNavDrawerItem({'label':'Most recent','action':'recent'});
			  _awac.addNavDrawerItem({'label':'Show Comments','action':'comments'});
			  _awac.addNavDrawerItem({'label':'History','action':'history'});
			  _awac.unlockNavDrawer();

			  //_awac.setHomeItem({'label':'Back','icon':'arrow_back','action':'back'});
			  _awac.addActionBarItem({'icon':'add','label':'ADD','action':'add'});
			  _awac.addActionBarItem({'icon':'edit','label':'EDIT','action':'edit'});

			  _awac.setOnBackPressed(function() { onAction('back'); });


			  new AttrType('name');
			  new AttrType('type');
			  var at = AttrType.get('name');
			  console.log('got at='+at);

			  FItem.get(_itemId,function(fitem) {
			    _fitem = fitem;
			    var iname = fitem.getMDIcon();
			    var a = fitem.getUserHTML(fitem.json.author,true);
			    if (fitem.json.image_url) {
			      $('#item-title-div').html(
			        '<div class="img-container"><img src="'+fitem.json.image_url+'"/>'+
			              '<div class="top"><div class="item-type-inner"><div class="item-type"><i class="material-icons">'+iname+'</i></div></div></div>'+
			              '<div class="img-title"><div class="img-title-inner">'+fitem.json.name_attr+'</div></div>'+
			        '</div>');
			        $('#show-item-type').remove();
			    }
			    else {
			      renderItemHeader(fitem,iname,a);
			    }

			    $('#show-item-markdown').html(fitem.getHTML());
			    $('#show-item-attrs').html(fitem.getAttrsHTML());

			    if (_fitem.json.item_type_name == 'Page')
			      FItem.getLinkedItems('Page','parent',_fitem.json.item_id,onGetLinkedItems);
			    else if (_fitem.json.item_type_name == 'Tag')
			      FItem.getLinkedItems(null,'tag',_fitem.json.item_id,onGetLinkedItems);

			    FItem.getLinkedItems('Comment','parent',_fitem.json.item_id,onGetCommentItems);

					startPage();
			  });
			});
			</script>
	</head>
	<body>
		 <div id="toplevel" class="mdl-layout mdl-js-layout">

	   <div id="item-title-div">-item-title-goes-here-</div>
     <div id="item-types-div"></div>

     <div id="show-item-content">
       <div class="padded-container">
         <div id="show-item-markdown">-item-markup-goes-here-</div>
         <div id="show-item-attrs">-item-attrs-go-here-</div>
       </div>
     </div>

     <div id="linked-items"></div>
     <div id="comment-items"></div>

		 <div id="test-area"></div>

     <div class="show-item-footer padded-container">
        <a href="javascript:onAction('edit');">EDIT</a> |  <a href="javascript:onAction('back');">BACK</a> |  <a href="javascript:onAction('test');">TEST</a>
     </div>

	 </div> <!-- toplevel -->
	</body>
</html>
